<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Historial de {{ patient.nombre }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    
    <style>
        .annotation-modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.7); display: none;
            justify-content: center; align-items: center; z-index: 1000;
        }
        .annotation-modal-content {
            background-color: #fff; padding: 20px; border-radius: 8px;
            width: 90%; max-width: 1200px;
            max-height: 90vh; 
            display: flex;
            flex-direction: column;
        }
        .annotation-toolbar {
            margin-bottom: 15px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;
            align-items: center;
        }
        .toolbar-btn {
            background-color: #6c757d; color: white; border: none; padding: 8px 12px;
            cursor: pointer; border-radius: 5px; transition: background-color 0.2s;
        }
        .toolbar-btn:hover { background-color: #5a6268; }
        .toolbar-btn.active { background-color: #007bff; }
        #annotation-canvas-container { 
            border: 1px solid #ccc; overflow: auto; flex-shrink: 1;
            display: flex; justify-content: center; align-items: center;
        }

        .gallery-item .actions {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            /* LÍNEA MODIFICADA: Padding ajustado para desplazar los botones a la izquierda */
            padding: 8px 20px 8px 8px; 
        }
        .gallery-item .actions .button {
            width: 90px;
            padding: 8px 0;
            font-size: 14px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
            box-sizing: border-box;
            text-align: center;
        }
        .gallery-item .actions .annotate-btn {
            background-color: #007bff;
            color: white;
        }
        .gallery-item .actions .delete-form {
            margin: 0;
            padding: 0;
        }
        .gallery-item .actions .delete-initial-btn {
            background-color: #dc3545;
            color: white;
        }
        .gallery-item .delete-confirm-span {
            display: none;
            width: 100%;
            gap: 8px;
            justify-content: center;
            align-items: center;
        }
        .gallery-item .actions.delete-active .annotate-btn,
        .gallery-item .actions.delete-active .delete-initial-btn {
            display: none;
        }
        .gallery-item .actions.delete-active .delete-form {
            width: 100%;
        }
        .gallery-item .actions.delete-active .delete-confirm-span {
            display: flex;
        }
        .gallery-item .confirm-btn { background-color: #28a745; }
        .gallery-item .cancel-btn { background-color: #ffc107; }
    </style>
</head>
<body>
    <div class="header">
        <div class="user-info">
            Sesión iniciada como: <strong>{{ user.email }}</strong> (Rol: {{ user.role }})
        </div>
        <a href="{{ url_for('logout') }}" class="logout-btn">Cerrar Sesión</a>
    </div>

    <div class="container">
        <h1>Historial Clínico del Paciente</h1>
        
        <details class="collapsible" open>
            <summary>Datos y Historial del Paciente</summary>
            <div class="form-section">
                <form id="update-form" action="{{ url_for('update_history', firestore_patient_id=patient.firestore_id) }}" method="POST">
                    <fieldset id="patient-fieldset" disabled>
                        <h2>Datos de Identificación</h2>
                        <div class="form-group"><label for="nombre">Nombre(s)</label><input type="text" id="nombre" name="nombre" value="{{ patient.nombre or '' }}" required></div>
                        <div class="form-group"><label for="apellido">Apellido(s)</label><input type="text" id="apellido" name="apellido" value="{{ patient.apellido or '' }}" required></div>
                        <div class="form-group"><label for="cedula">Cédula de Identidad</label><input type="text" id="cedula" name="cedula" value="{{ patient.cedula or '' }}" required></div>
                        <div class="form-group"><label for="email">Correo Electrónico del Paciente</label><input type="email" id="email" name="email" value="{{ patient.email or '' }}"></div>
                        <div class="form-group"><label for="edad">Edad</label><input type="number" id="edad" name="edad" max="99" oninput="if(this.value.length > 2) this.value = this.value.slice(0, 2);" value="{{ patient.edad or '' }}"></div>
                        <div class="form-group"><label for="telefono">Teléfono</label><input type="text" id="telefono" name="telefono" value="{{ patient.telefono or '' }}"></div>

                        <h2 style="margin-top: 30px;">Historial Clínico Detallado</h2>
                        <div class="form-group"><label for="fecha_sintomas">Fecha de Inicio de los Síntomas</label><input type="date" id="fecha_sintomas" name="fecha_sintomas" value="{{ patient.history.fecha_sintomas if patient.history else '' }}"></div>
                        <div class="form-group"><label for="fecha_diagnostico">Fecha de Diagnóstico</label><input type="date" id="fecha_diagnostico" name="fecha_diagnostico" value="{{ patient.history.fecha_diagnostico if patient.history else '' }}"></div>
                        <div class="form-group"><label for="diagnostico_medico">Diagnóstico Médico</label><textarea id="diagnostico_medico" name="diagnostico_medico" rows="3">{{ patient.history.diagnostico_medico if patient.history else '' }}</textarea></div>
                        <div class="form-group"><label>Tratamiento Farmacológico</label><textarea name="tratamiento_farmacologico" rows="2" placeholder="Describa...">{{ patient.history.tratamiento_farmacologico if patient.history else '' }}</textarea></div>
                        <div class="form-group"><label>Tratamiento Conservador</label><textarea name="tratamiento_conservador" rows="2" placeholder="Describa...">{{ patient.history.tratamiento_conservador if patient.history else '' }}</textarea></div>
                        <div class="form-group"><label>Tratamiento Quirúrgico</label><textarea name="tratamiento_quirurgico" rows="2" placeholder="Describa...">{{ patient.history.tratamiento_quirurgico if patient.history else '' }}</textarea></div>
                    </fieldset>
                    
                    <div id="form-actions" style="margin-top: 20px;">
                        <button type="button" id="edit-btn" class="button btn-edit">Modificar Datos</button>
                        <button type="submit" id="save-btn" class="button form-submit-btn" style="display: none;">Guardar Cambios</button>
                        <button type="button" id="cancel-btn" class="button" style="display: none; background-color: #6c757d;">Cancelar</button>
                    </div>
                </form>
            </div>
        </details>

        <h2>Galería de Capturas</h2>
        <hr>
        {% if captures %}
            <div class="gallery">
                {% for capture in captures %}
                <div class="gallery-item">
                    <a href="{{ capture.annotated_url or capture.cloud_url }}" target="_blank">
                        <img src="{{ capture.annotated_url or capture.cloud_url }}" alt="Captura para {{ patient.nombre }}">
                    </a>
                    <div class="actions">
                        {% if user.role == 'doctor' %}
                            <button class="button annotate-btn" 
                                    data-image-url="{{ capture.cloud_url }}"
                                    data-capture-id="{{ capture.firestore_id }}"
                                    data-annotation-json='{{ capture.annotation_data | safe if capture.annotation_data else "" }}'>
                                Anotar
                            </button>
                            <form action="{{ url_for('delete_capture', firestore_capture_id=capture.firestore_id) }}" method="POST" class="delete-form">
                                <button type="button" class="button delete-initial-btn">Eliminar</button>
                                <span class="delete-confirm-span">
                                    <span>¿Seguro?</span>
                                    <button type="submit" class="button confirm-btn">Sí</button>
                                    <button type="button" class="button cancel-btn">No</button>
                                </span>
                            </form>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <p style="text-align: center; font-style: italic; color: #777;">No hay imágenes capturadas para este paciente todavía.</p>
        {% endif %}

        {% if user.role == 'doctor' and captures %}
        <details class="collapsible" open>
            <summary>Análisis y Generación de Informe</summary>
            <div class="form-section report-form">
                <form action="{{ url_for('save_analysis', firestore_patient_id=patient.firestore_id) }}" method="POST">
                    <fieldset>
                        <legend>1. Capturas a Incluir</legend>
                        <div class="checkbox-grid">
                            {% for capture in captures %}
                            <div class="checkbox-item">
                                <input type="checkbox" name="selected_captures" value="{{ capture.firestore_id }}" id="capture_{{ loop.index }}">
                                <label for="capture_{{ loop.index }}">
                                    Captura del {{ capture.timestamp.strftime('%d-%m-%Y %H:%M') }}
                                    <strong>({{ capture.study_area or 'General' }})</strong>
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                    </fieldset>
                    <fieldset>
                        <legend>2. Extremidad Evaluada</legend>
                        <div class="checkbox-grid">
                            <div class="checkbox-item"><input type="checkbox" name="extremidad" value="Brazo Derecho"> Brazo Derecho</div>
                            <div class="checkbox-item"><input type="checkbox" name="extremidad" value="Brazo Izquierdo"> Brazo Izquierdo</div>
                            <div class="checkbox-item"><input type="checkbox" name="extremidad" value="Pierna Derecha"> Pierna Derecha</div>
                            <div class="checkbox-item"><input type="checkbox" name="extremidad" value="Pierna Izquierda"> Pierna Izquierda</div>
                        </div>
                    </fieldset>
                    <fieldset>
                        <legend>3. Hallazgos Observados</legend>
                        <div class="checkbox-grid">
                            <div class="checkbox-item"><input type="checkbox" name="hallazgos" value="Flujo Lineal (Normal)"> Flujo Lineal (Normal)</div>
                            <div class="checkbox-item"><input type="checkbox" name="hallazgos" value="Flujo Lento"> Flujo Lento</div>
                            <div class="checkbox-item"><input type="checkbox" name="hallazgos" value="Patrón Punteado (Reflujo Dérmico)"> Patrón Punteado (Reflujo Dérmico)</div>
                            <div class="checkbox-item"><input type="checkbox" name="hallazgos" value="Vasos Colaterales"> Vasos Colaterales</div>
                            <div class="checkbox-item"><input type="checkbox" name="hallazgos" value="Obstrucción"> Obstrucción</div>
                            <div class="checkbox-item"><input type="checkbox" name="hallazgos" value="Ausencia de Captación"> Ausencia de Captación</div>
                        </div>
                    </fieldset>
                    <fieldset>
                        <legend>4. Conclusiones y Recomendaciones</legend>
                        <div class="form-group">
                            <textarea name="conclusiones" rows="4" placeholder="Escriba aquí sus conclusiones..."></textarea>
                        </div>
                    </fieldset>
                    <button type="submit" class="button form-submit-btn">Guardar y Generar Informe PDF</button>
                </form>
            </div>
        </details>
        {% endif %}

        <div class="actions-container">
            <a href="{{ url_for('patient_list') }}" class="button back-link">← Volver a la Lista</a>
            {% if user.role == 'doctor' %}
            <form action="{{ url_for('delete_patient', firestore_patient_id=patient.firestore_id) }}" method="POST" class="delete-form">
                <button type="button" class="button delete-patient-btn delete-initial-btn">Eliminar Paciente</button>
                <span class="delete-confirm-span">
                    <span>¿Seguro?</span>
                    <button type="submit" class="button confirm-btn">Sí, eliminar</button>
                    <button type="button" class="button cancel-btn">No</button>
                </span>
            </form>
            {% endif %}
        </div>
    </div>
    
    <div id="annotation-modal" class="annotation-modal-overlay">
        <div class="annotation-modal-content">
            <h3>Editor de Anotaciones</h3>
            <div class="annotation-toolbar">
                <button id="draw-mode-btn" class="toolbar-btn">Dibujar</button>
                <button id="text-mode-btn" class="toolbar-btn">Añadir Texto</button>
                <input type="color" id="color-picker" value="#ff0000" title="Seleccionar color">
                <button id="delete-selected-btn" class="toolbar-btn">Borrar Selección</button>
                <button id="clear-all-btn" class="toolbar-btn">Limpiar Todo</button>
            </div>
            <div id="annotation-canvas-container">
                <canvas id="annotation-canvas"></canvas>
            </div>
            <div style="margin-top: 15px;">
                <button id="save-annotation-btn" class="button form-submit-btn" style="width: auto;">Guardar Anotación</button>
                <button id="close-modal-btn" class="button" style="background-color: #6c757d;">Cerrar</button>
                <p id="annotation-status" style="margin-top: 10px; font-weight: bold;"></p>
            </div>
        </div>
    </div>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const fieldset = document.getElementById('patient-fieldset');
        const editBtn = document.getElementById('edit-btn');
        const saveBtn = document.getElementById('save-btn');
        const cancelFormBtn = document.getElementById('cancel-btn');

        if (fieldset && editBtn && saveBtn && cancelFormBtn) {
            editBtn.addEventListener('click', () => {
                fieldset.disabled = false;
                editBtn.style.display = 'none';
                saveBtn.style.display = 'inline-block';
                cancelFormBtn.style.display = 'inline-block';
            });
            cancelFormBtn.addEventListener('click', () => {
                fieldset.disabled = true;
                editBtn.style.display = 'inline-block';
                saveBtn.style.display = 'none';
                cancelFormBtn.style.display = 'none';
                window.location.reload();
            });
        }
        
        document.querySelectorAll('.delete-form').forEach(form => {
            const initialBtn = form.querySelector('.delete-initial-btn');
            const confirmSpan = form.querySelector('.delete-confirm-span');
            const cancelBtn = form.querySelector('.cancel-btn');
            const actionsDiv = form.closest('.actions');

            if (initialBtn && confirmSpan && cancelBtn && actionsDiv) {
                initialBtn.addEventListener('click', () => {
                    actionsDiv.classList.add('delete-active');
                });
                cancelBtn.addEventListener('click', () => {
                    actionsDiv.classList.remove('delete-active');
                });
            }
        });

        const modal = document.getElementById('annotation-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const saveAnnotationBtn = document.getElementById('save-annotation-btn');
        const statusMessage = document.getElementById('annotation-status');
        let canvas, currentCaptureId;

        document.querySelectorAll('.annotate-btn').forEach(button => {
            button.addEventListener('click', () => {
                const originalImageUrl = button.dataset.imageUrl;
                const annotationJson = button.dataset.annotationJson;
                currentCaptureId = button.dataset.captureId;
                
                const imageUrlToLoad = originalImageUrl;

                modal.style.display = 'flex';
                statusMessage.textContent = 'Cargando imagen...';

                if (!canvas) {
                    canvas = new fabric.Canvas('annotation-canvas');
                }
                
                canvas.clear();
                fabric.Image.fromURL(imageUrlToLoad, (img) => {
                    const MAX_WIDTH = document.querySelector('.annotation-modal-content').clientWidth * 0.95;
                    const MAX_HEIGHT = 500;
                    let scaleFactor = 1;

                    if (img.width > MAX_WIDTH || img.height > MAX_HEIGHT) {
                        scaleFactor = Math.min(MAX_WIDTH / img.width, MAX_HEIGHT / img.height);
                    }

                    const canvasWidth = img.width * scaleFactor;
                    const canvasHeight = img.height * scaleFactor;
                    
                    canvas.setWidth(canvasWidth);
                    canvas.setHeight(canvasHeight);
                    
                    canvas.setBackgroundImage(img, canvas.renderAll.bind(canvas), {
                        scaleX: scaleFactor,
                        scaleY: scaleFactor
                    });
                    
                    if (annotationJson && annotationJson.trim() !== "") {
                        canvas.loadFromJSON(JSON.parse(annotationJson), canvas.renderAll.bind(canvas));
                    }

                    statusMessage.textContent = '';
                }, { crossOrigin: 'anonymous' });
            });
        });

        closeModalBtn.addEventListener('click', () => {
            modal.style.display = 'none';
        });

        saveAnnotationBtn.addEventListener('click', async () => {
            statusMessage.textContent = 'Guardando...';
            const annotationData = canvas.toJSON();

            const originalImage = canvas.backgroundImage;
            if (!originalImage) {
                statusMessage.textContent = 'Error: No hay imagen de fondo.';
                return;
            }
            const zoom = 1 / originalImage.scaleX;
            const dataURL = canvas.toDataURL({
                format: 'png',
                multiplier: zoom
            });

            try {
                const response = await fetch(`/save_annotation/${currentCaptureId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        imageData: dataURL,
                        annotationData: annotationData
                    })
                });
                const result = await response.json();
                if (response.ok) {
                    statusMessage.textContent = result.message;
                    setTimeout(() => {
                        modal.style.display = 'none';
                        window.location.reload();
                    }, 1500);
                } else {
                    statusMessage.textContent = `Error: ${result.message}`;
                }
            } catch (error) {
                statusMessage.textContent = 'Error de conexión con el servidor.';
                console.error('Error:', error);
            }
        });
        
        const drawModeBtn = document.getElementById('draw-mode-btn');
        const textModeBtn = document.getElementById('text-mode-btn');
        const colorPicker = document.getElementById('color-picker');
        const deleteSelectedBtn = document.getElementById('delete-selected-btn');
        const clearAllBtn = document.getElementById('clear-all-btn');

        drawModeBtn.addEventListener('click', () => {
            canvas.isDrawingMode = !canvas.isDrawingMode;
            if (canvas.isDrawingMode) {
                drawModeBtn.classList.add('active');
                textModeBtn.classList.remove('active');
                canvas.freeDrawingBrush.color = colorPicker.value;
                canvas.freeDrawingBrush.width = 5;
            } else {
                drawModeBtn.classList.remove('active');
            }
        });

        colorPicker.addEventListener('input', () => {
            const color = colorPicker.value;
            canvas.freeDrawingBrush.color = color;
            if (canvas.getActiveObject()) {
                canvas.getActiveObject().set('fill', color);
                canvas.renderAll();
            }
        });

        textModeBtn.addEventListener('click', () => {
            canvas.isDrawingMode = false;
            drawModeBtn.classList.remove('active');
            textModeBtn.classList.add('active');
            
            const text = new fabric.IText('Escribe aquí', {
                left: canvas.getCenter().left,
                top: canvas.getCenter().top,
                originX: 'center',
                originY: 'center',
                fill: colorPicker.value,
                fontSize: 24,
                fontFamily: 'Helvetica'
            });
            canvas.add(text);
            canvas.setActiveObject(text);
            canvas.renderAll();
            setTimeout(() => textModeBtn.classList.remove('active'), 500);
        });
        
        deleteSelectedBtn.addEventListener('click', () => {
            const activeObjects = canvas.getActiveObjects();
            if (activeObjects.length > 0) {
                activeObjects.forEach(obj => {
                    canvas.remove(obj);
                });
                canvas.discardActiveObject();
                canvas.requestRenderAll();
            } else {
                statusMessage.textContent = "Para borrar, primero haz clic sobre un elemento en la imagen.";
                setTimeout(() => statusMessage.textContent = "", 3000);
            }
        });
        
        clearAllBtn.addEventListener('click', () => {
            canvas.remove(...canvas.getObjects());
            canvas.renderAll();
        });
    });
    </script>
</body>
</html>